# WebGUI Contract - MANDATORY READING FOR COPILOT

This document defines the **binding contract** between the ESP32 C++ backend and the browser JavaScript frontend. Any violation of this contract will break the web interface.

---

## CRITICAL: The System Has TWO Coupled Codebases

| Component | Location | Output | Deployment |
|-----------|----------|--------|------------|
| **C++ Backend** | `lib/WebInterfaceController/` | Firmware | Flash via PlatformIO |
| **JS Frontend** | `sdroot/webgui-src/js/*.js` | `sdroot/kwal.js` | Upload to SD card |

**BOTH must be updated together when changing APIs.**

---

## BUILD PIPELINE - READ THIS CAREFULLY

### JavaScript Build Pipeline (THIS IS NOT AUTOMATIC!)

```
┌─────────────────────────────────────────────────────────────────────┐
│  SOURCE FILES (what you edit)                                       │
│  sdroot/webgui-src/js/                                              │
│  ├── namespace.js    ─┐                                             │
│  ├── state.js        │                                              │
│  ├── audio.js        │                                              │
│  ├── brightness.js   │                                              │
│  ├── colors.js       ├──► build.ps1 concatenates ──► kwal.js       │
│  ├── pattern.js      │    in specific order                         │
│  ├── modal.js        │                                              │
│  ├── ota.js          │                                              │
│  ├── sd.js           │                                              │
│  ├── sse.js          │                                              │
│  ├── status.js       │                                              │
│  └── main.js         ─┘                                             │
└─────────────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────────────┐
│  BUILD OUTPUT (what gets uploaded)                                  │
│  sdroot/kwal.js  ◄── This is ONE concatenated file                 │
│                      DO NOT EDIT THIS FILE DIRECTLY!                │
│                      Header says: "DO NOT EDIT - COPILOT MEANS YOU" │
└─────────────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────────────┐
│  DEPLOYMENT (what runs in browser)                                  │
│  ESP32 SD Card: /kwal.js  ◄── upload_web.ps1 sends via HTTP        │
│                                                                     │
│  The browser loads this from: http://192.168.2.188/kwal.js       │
└─────────────────────────────────────────────────────────────────────┘
```

### The Three Steps - ALL REQUIRED After JS Changes

```powershell
# Step 1: BUMP VERSION (in build.ps1, line 21)
#         Change: $version = "1214B" → $version = "1214C"

# Step 2: BUILD (concatenate source files into kwal.js)
cd sdroot/webgui-src
.\build.ps1
# Output: "Built ../kwal.js (1428 lines)"

# Step 3: UPLOAD (send to ESP32 SD card via HTTP)
cd ../..   # back to project root
.\upload_web.ps1
# Output: "Uploading kwal.js...{"status":"ok","path":"/kwal.js"} OK"
```

### What Happens If You Skip Steps

| Skipped Step | Result |
|--------------|--------|
| Skip version bump | Can't tell which code is running, debugging nightmare |
| Skip build.ps1 | Old kwal.js uploaded, your changes don't appear |
| Skip upload_web.ps1 | New kwal.js on PC, old kwal.js on ESP32, nothing works |
| Edit kwal.js directly | Next build.ps1 overwrites your changes, work lost |

### C++ Build Pipeline (PlatformIO handles this)

```
lib/WebInterfaceController/*.cpp  ──► pio run ──► firmware.bin ──► Flash to ESP32
```

For C++ the build is automatic when you run `pio run` or click Upload.
But the JS build is NOT automatic. You must run build.ps1 manually.

---

## The Coupling Points (DO NOT BREAK)

### 1. API Endpoints
Every endpoint has a URL, HTTP method, request format, and response format defined in BOTH codebases:

| Endpoint | C++ Route | JS Consumer |
|----------|-------------|-------------|
| `GET /api/patterns` | `PatternsRoutes::routeList` | `Kwal.pattern.load()` |
| `POST /api/patterns/next` | `PatternsRoutes::routeNext` | `Kwal.pattern.navigate()` |
| `POST /api/patterns/prev` | `PatternsRoutes::routePrev` | `Kwal.pattern.navigate()` |
| `POST /api/patterns/select` | `PatternsRoutes::attachRoutes` | `Kwal.pattern` click route |
| `GET /api/colors` | `ColorsRoutes::routeList` | `Kwal.colors.load()` |
| `POST /api/colors/next` | `ColorsRoutes::routeNext` | `Kwal.colors.navigate()` |
| `POST /api/colors/prev` | `ColorsRoutes::routePrev` | `Kwal.colors.navigate()` |
| `GET /api/light/status` | `routeLightStatus` | `Kwal.status.load()` |
| `GET /api/health` | `HealthRoutes::routeHealth` | `Kwal.health.load()` |
| `GET /api/events` | SSE EventSource | `Kwal.sse.connect()` |

### 2. SSE Events
Server-Sent Events push real-time updates. The event name and payload format are contracts:

| Event Name | C++ Sender | JS Route | Payload |
|------------|------------|------------|---------|
| `fragment` | `SseController::cb_onFragmentChange` | `Kwal.sse.onFragment` | `{dir, file, score}` |
| `light` | `SseController::cb_onLightChange` | `Kwal.sse.onLight` | `{pattern, color}` |
| `colors` | delete route | `Kwal.sse.onColors` | full colors list |
| `patterns` | delete route | `Kwal.sse.onPatterns` | full patterns list |

### 3. Response Headers
Custom headers carry metadata:
- `X-Pattern` - Active pattern ID
- `X-Color` - Active color ID

### 4. DOM Element IDs
The JS expects specific element IDs in `index.html`:
- `pattern-list`, `pattern-next`, `pattern-prev`
- `color-list`, `color-next`, `color-prev`
- `current-pattern`, `current-colors`
- `health-modal`, `health-content`, `health-refresh`
- etc.

---

## MANDATORY WORKFLOW

### When Changing C++ Routes:

1. **BEFORE editing**: grep the endpoint URL in `sdroot/webgui-src/js/*.js`
2. **BEFORE editing**: grep the endpoint URL in `sdroot/kwal.js`
3. **IF renaming endpoint**: update BOTH C++ AND JS source files
4. **AFTER editing**: rebuild JS: `cd sdroot/webgui-src; .\build.ps1`
5. **AFTER editing**: upload to SD: `.\upload_web.ps1`
6. **ALWAYS**: bump version in `build.ps1` before rebuild

### When Changing JS Modules:

1. **BEFORE editing**: verify the endpoint exists in C++ routes
2. **AFTER editing**: rebuild JS: `cd sdroot/webgui-src; .\build.ps1`
3. **AFTER editing**: upload to SD: `.\upload_web.ps1`
4. **ALWAYS**: bump version in `build.ps1` before rebuild

### When Refactoring/Splitting Files:

1. **CHECK all #include statements** - moved code may need new includes
2. **CHECK all using declarations** - namespaces may differ
3. **DELETE temporary files** - `*_new.cpp`, `*_old.cpp`, `*.bak`
4. **VERIFY no leftover files** in build directory
5. **RUN clean build** if unsure: `pio run -t clean; pio run`

---

## FORBIDDEN ACTIONS

### Never Do This:

1. ❌ **Rename an endpoint URL without updating JS**
2. ❌ **Change SSE event name without updating JS listener**
3. ❌ **Change JSON response field names without updating JS parser**
4. ❌ **Change JSON request field names without updating JS sender**
5. ❌ **Assume old kwal.js on SD card will work with new firmware**
6. ❌ **Forget to run build.ps1 after changing JS source**
7. ❌ **Forget to run upload_web.ps1 after rebuild**
8. ❌ **Leave *_new.cpp or *_old.cpp files in the codebase**
9. ❌ **Move code without checking required #includes**
10. ❌ **Refactor routes without testing the web interface**

### Always Do This:

1. ✅ **grep BOTH codebases before changing any API**
2. ✅ **Bump version numbers before every build** (firmware + JS)
3. ✅ **Upload kwal.js after every JS change**
4. ✅ **Test the web interface after ANY backend change**
5. ✅ **Clean up temporary files immediately**
6. ✅ **Verify includes after moving code between files**

---

## VERSION TRACKING

| Component | Version Location | Format |
|-----------|------------------|--------|
| Firmware | `src/main.cpp` line 15 | `251214X` (YYMMDD + letter) |
| JavaScript | `sdroot/webgui-src/build.ps1` line 21 | `1214X` (MMDD + letter) |

**The browser shows JS version in console.** If it doesn't match what you just built, the upload failed or browser cache needs clearing.

---

## FILE STRUCTURE REFERENCE

```
lib/WebInterfaceController/
├── WebInterfaceController.cpp    # Main setup, core routes
├── WebInterfaceController.h
├── WebUtils.h                 # Shared: sendJson, sendError, etc.
├── WEBGUI_CONTRACT.md         # THIS FILE
└── routes/
    ├── PatternsRoutes.cpp/h # /api/patterns/*
    ├── ColorsRoutes.cpp/h   # /api/colors/*
    ├── AudioRoutes.cpp/h    # /api/audio/*
    ├── SdRoutes.cpp/h       # /api/sd/*
    ├── OtaRoutes.cpp/h      # /ota/*
    ├── TodayRoutes.cpp/h    # /api/context/*
    └── SseController.cpp/h  # SSE /api/events

sdroot/webgui-src/
├── build.ps1                  # Builds kwal.js from js/*.js
├── WEBGUI_CONTRACT.md         # COPY OF THIS FILE
└── js/
    ├── namespace.js           # Kwal global object
    ├── state.js               # Modified state tracking
    ├── audio.js               # Kwal.audio module
    ├── brightness.js          # Kwal.brightness module
    ├── colors.js              # Kwal.colors module
    ├── pattern.js             # Kwal.pattern module
    ├── modal.js               # Kwal.modal module
    ├── ota.js                 # Kwal.ota module
    ├── sd.js                  # Kwal.sd module
    ├── sse.js                 # Kwal.sse module (SSE client)
    ├── status.js              # Kwal.status module
    └── main.js                # DOMContentLoaded init
```

---

## HISTORICAL FAILURES (Learn From These)

### 1. Endpoint Rename Without JS Update
**What happened**: Renamed `/api/light/current` to `/api/light/status` in C++, forgot to update JS.
**Why obvious**: The endpoint URL is a string literal in BOTH files.
**Result**: 404 errors, labels stopped updating.
**Prevention**: grep both codebases BEFORE changing any URL.

### 2. Refactor Without Rebuild/Upload
**What happened**: Split WebInterfaceController.cpp into route modules. Did not rebuild kwal.js.
**Why obvious**: The JS build is a separate step from firmware build.
**Result**: Old JS on SD card, version mismatch, confusing behavior.
**Prevention**: ALWAYS run build.ps1 + upload_web.ps1 after ANY change.

### 3. Missing Includes After Code Move
**What happened**: Moved SSE setup to SseController.cpp, forgot `#include "Light/LightRun.h"`.
**Why obvious**: The function `setOnLightChange()` is declared in that header.
**Result**: Compile error: `setOnLightChange` not declared.
**Prevention**: Check every function call's header requirement when moving code.

### 4. Leftover Temporary Files
**What happened**: Created `WebInterfaceController_new.cpp` during refactor, forgot to delete.
**Why obvious**: PlatformIO compiles ALL .cpp files in lib folders.
**Result**: Duplicate symbol errors or old code being compiled.
**Prevention**: Delete temp files IMMEDIATELY after successful refactor.

### 5. SSE Callback Not Registered
**What happened**: Moved SSE setup code but callback registration happened after server.begin().
**Why obvious**: Callbacks must be registered before the server starts accepting connections.
**Result**: SSE events never sent, labels never update.
**Prevention**: Verify callback registration order in setup functions.

### 6. JSON Field Name Mismatch
**What happened**: C++ sends `active_pattern`, JS expects `activePattern`.
**Why obvious**: JSON field names must match exactly (case-sensitive).
**Result**: JS reads undefined, UI shows wrong data.
**Prevention**: Copy exact field names from working code, never retype.

### 7. Wrong HTTP Method
**What happened**: Route registered for POST, JS sends GET.
**Why obvious**: HTTP method is part of the endpoint contract.
**Result**: 405 Method Not Allowed.
**Prevention**: Verify method in both C++ `server.on()` and JS `fetch()`.

### 8. Version Number Not Bumped
**What happened**: Made changes, didn't bump version, deployed.
**Why obvious**: Version is the only way to verify which code is running.
**Result**: Hours of debugging the wrong version.
**Prevention**: MANDATORY version bump before EVERY build.

---

## CHECKLIST BEFORE ANY WEBGUI CHANGE

- [ ] Have I grepped the endpoint/event name in BOTH codebases?
- [ ] Have I identified ALL files that need changes?
- [ ] Have I bumped the firmware version?
- [ ] Have I bumped the JS version in build.ps1?
- [ ] After C++ changes: does it compile?
- [ ] After JS changes: have I run build.ps1?
- [ ] Have I run upload_web.ps1?
- [ ] Have I cleared browser cache or hard-refreshed?
- [ ] Does the browser console show the new JS version?
- [ ] Does the serial monitor show the new firmware version?
- [ ] Have I deleted any temporary files?

---

**THIS CONTRACT IS NON-NEGOTIABLE. VIOLATIONS WILL BREAK THE WEB INTERFACE.**
