WebLog Feature Plan
===================
Created: 2025-12-25
Status: APPROVED FOR IMPLEMENTATION

== DOEL ==
Serial logging zichtbaar maken via WebGUI zonder USB-kabel.
Geen losse add-on, maar geïntegreerd in bestaande PL/PF macro-architectuur.

== KERN IDEE ==
PL/PF macros doen nu:
  - Serial.println / Serial.printf (als SERIAL_ENABLED=1)
  - Niets (als SERIAL_ENABLED=0)

Na wijziging:
  - LogBuffer::append() ALTIJD (ringbuffer vullen)
  - Serial.println / Serial.printf (als SERIAL_ENABLED=1)

WebGUI kan buffer lezen via GET /log endpoint.
Geen runtime flags, geen compile-time LOG_TO_WIFI flag nodig.

== ARCHITECTUUR ==
Ringbuffer in RAM (~8 KB):
  - Circular buffer, overschrijft oudste entries
  - Geen allocaties na init
  - Thread-safe (ISR-safe niet nodig, alleen main loop)

Macro flow:
  PL("tekst") → LogBuffer::appendLine("tekst") + Serial.println("tekst")
  PF("fmt", x) → LogBuffer::appendf("fmt", x) + Serial.printf("fmt", x)

Endpoint:
  GET /log → text/plain met buffer inhoud
  GET /log/clear → wist buffer, returnt "OK"

WebGUI:
  Dev modal → View Log knop → log-modal met <pre> element
  Refresh knop haalt /log opnieuw op

== COMPONENTEN ==

1. LogBuffer (header-only)
   File: lib/Globals/LogBuffer.h
   
   Namespace LogBuffer met:
   - char buffer[8192]
   - size_t head, tail
   - void appendLine(const char* msg)
   - void appendf(const char* fmt, ...)
   - size_t read(char* out, size_t maxLen)
   - void clear()
   - size_t available()

   GEEN class, GEEN singleton pattern.
   Static inline functies in namespace.

2. macros.inc wijzigingen
   File: lib/Globals/macros.inc
   
   Bovenaan toevoegen:
     #include "LogBuffer.h"
   
   PL macro wordt (SERIAL_ENABLED=1 sectie):
     #define PL(x) do { LogBuffer::appendLine(x); Serial.println(x); } while(0)
   
   PF macro wordt:
     #define PF(...) do { LogBuffer::appendf(__VA_ARGS__); Serial.printf(__VA_ARGS__); } while(0)
   
   SERIAL_ENABLED=0 sectie:
     #define PL(x) LogBuffer::appendLine(x)
     #define PF(...) LogBuffer::appendf(__VA_ARGS__)
   
   Opmerking: Ook bij SERIAL_ENABLED=0 vullen we buffer!
   Zo kan je via WiFi logs zien ook zonder USB.

3. LogHandlers (C++ endpoint)
   Files: 
     lib/WebInterfaceManager/handlers/LogHandlers.h
     lib/WebInterfaceManager/handlers/LogHandlers.cpp
   
   LogHandlers.h:
     #pragma once
     #include <ESPAsyncWebServer.h>
     namespace LogHandlers {
         void attachRoutes(AsyncWebServer &server);
     }
   
   LogHandlers.cpp:
     #include "LogHandlers.h"
     #include "LogBuffer.h"
     
     namespace LogHandlers {
     
     void handleLog(AsyncWebServerRequest *request) {
         // Stream buffer content
         size_t len = LogBuffer::available();
         char* temp = new char[len + 1];
         LogBuffer::read(temp, len);
         temp[len] = '\0';
         request->send(200, "text/plain", temp);
         delete[] temp;
     }
     
     void handleLogClear(AsyncWebServerRequest *request) {
         LogBuffer::clear();
         request->send(200, "text/plain", "OK");
     }
     
     void attachRoutes(AsyncWebServer &server) {
         server.on("/log", HTTP_GET, handleLog);
         server.on("/log/clear", HTTP_GET, handleLogClear);
     }
     
     } // namespace LogHandlers

4. WebInterfaceManager integratie
   File: lib/WebInterfaceManager/WebInterfaceManager.cpp
   
   Toevoegen include:
     #include "handlers/LogHandlers.h"
   
   In attachRoutes() of init(), toevoegen:
     LogHandlers::attachRoutes(server);

5. index.html wijziging
   File: sdroot/index.html
   
   In dev-modal, na bestaande buttons, toevoegen:
     <button data-open="log-modal">View Log</button>
   
   Nieuw modal toevoegen (na dev-modal):
     <div id="log-modal" class="modal">
       <div class="modal-box modal-wide">
         <h3>Serial Log</h3>
         <pre id="log-content" class="log-view"></pre>
         <button id="log-refresh">Refresh</button>
         <button id="log-clear">Clear</button>
         <button data-close data-return="dev-modal">Close</button>
       </div>
     </div>

6. styles.css wijziging
   File: sdroot/styles.css
   
   Toevoegen:
     .modal-wide .modal-box { max-width: 90%; width: 600px; }
     .log-view { 
       background: #111; 
       color: #0f0; 
       font-family: monospace;
       font-size: 11px;
       max-height: 400px;
       overflow: auto;
       padding: 8px;
       white-space: pre-wrap;
       word-wrap: break-word;
     }

7. log.js (nieuw)
   File: sdroot/webgui-src/js/log.js
   
   (function() {
     'use strict';
     
     function fetchLog() {
       var pre = document.getElementById('log-content');
       if (!pre) return;
       
       fetch('/log')
         .then(function(r) { return r.text(); })
         .then(function(txt) { 
           pre.textContent = txt;
           pre.scrollTop = pre.scrollHeight;
         })
         .catch(function(e) { pre.textContent = 'Error: ' + e; });
     }
     
     function clearLog() {
       fetch('/log/clear')
         .then(function() { fetchLog(); })
         .catch(function(e) { console.error('Clear failed:', e); });
     }
     
     document.addEventListener('DOMContentLoaded', function() {
       var refreshBtn = document.getElementById('log-refresh');
       var clearBtn = document.getElementById('log-clear');
       
       if (refreshBtn) refreshBtn.onclick = fetchLog;
       if (clearBtn) clearBtn.onclick = clearLog;
       
       // Auto-fetch when modal opens
       var logModal = document.getElementById('log-modal');
       if (logModal) {
         var observer = new MutationObserver(function(mutations) {
           mutations.forEach(function(m) {
             if (m.attributeName === 'class' && 
                 logModal.classList.contains('open')) {
               fetchLog();
             }
           });
         });
         observer.observe(logModal, { attributes: true });
       }
     });
   })();

8. build.ps1 wijziging
   File: sdroot/build.ps1
   
   a) Version bump: $version = "v1.XX" → "v1.YY" (of wat huidige is +1)
   
   b) In $jsFiles array, toevoegen:
        "webgui-src/js/log.js"

9. Globals.h version bump
   File: lib/Globals/Globals.h
   
   FIRMWARE_VERSION wijzigen naar "251225B" (of volgende letter)

== VOLGORDE VAN IMPLEMENTATIE ==
1. LogBuffer.h aanmaken
2. macros.inc wijzigen
3. LogHandlers.h/.cpp aanmaken
4. WebInterfaceManager.cpp wijzigen
5. index.html wijzigen
6. styles.css wijzigen
7. log.js aanmaken
8. build.ps1 wijzigen
9. Globals.h version bump
10. Compileren (firmware)
11. build.ps1 runnen (JS)
12. upload_web.ps1 runnen (SD)
13. Testen

== VERIFICATIE ==
1. Firmware compileert zonder errors
2. Serial output werkt exact als voorheen
3. Browser: Dev → View Log → toont buffer inhoud
4. Refresh knop haalt nieuwe data
5. Clear knop wist buffer
6. Na SERIAL_ENABLED=0: geen Serial output, maar /log WEL gevuld

== NIET DOEN ==
- Geen LOG_TO_WIFI compile flag (niet nodig)
- Geen runtime flags
- Geen singleton class voor LogBuffer
- Geen aparte Logger module met complexe inheritance
- Geen UDP broadcasting
- Geen SSE/WebSocket voor live streaming (later eventueel)

== EDGE CASES ==
1. Buffer vol: oudste entries overschreven (circular)
2. Concurrent access: niet relevant (single-threaded main loop)
3. Boot logs: beschikbaar zodra WiFi connected en webserver draait
4. Long lines: afgekapt op buffer grootte, geen probleem

== FUTURE (niet nu) ==
- Live streaming via SSE
- Filter op log level
- Download als file
- Timestamp per regel
